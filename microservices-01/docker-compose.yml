services:
  kafka:
    image: apache/kafka:latest  # Or latest stable >=3.3
    container_name: kafka-kraft
    ports:
      - 9092:9092        # Kafka client port
      - 9093:9093        # Controller listener (optional for single node, but good practice)
    environment:
      CLUSTER_ID: "lsAVcjcjRx6iqVHFRwE2lA"  # Generate once with `kafka-storage.sh random-uuid`
      BROKER_ID: 1
      CONTROLLER_QUORUM_VOTERS: "1@kafka:9093"
      LISTENERS: "PLAINTEXT://:9092,CONTROLLER://:9093"
      ADVERTISED_LISTENERS: "PLAINTEXT://localhost:9092"
      CONTROLLER_LISTENER_NAMES: "CONTROLLER"
      PROCESS_ROLES: "broker,controller"  # Combined mode (broker + controller)
      KAFKA_CFG_NODE_ID: 1
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: "1@kafka:9093"
      KAFKA_CFG_PROCESS_ROLES: "broker,controller"
      KAFKA_CFG_LISTENERS: "PLAINTEXT://:9092,CONTROLLER://:9093"
      KAFKA_CFG_ADVERTISED_LISTENERS: "PLAINTEXT://localhost:9092"
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: "CONTROLLER"
      KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: "CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT"
      KAFKA_CFG_INTER_BROKER_LISTENER_NAME: "PLAINTEXT"
    volumes:
      - ./kafka-data:/opt/kafka/data
    command: >
      bash -c "
        /opt/kafka/bin/kafka-storage.sh format -t $${CLUSTER_ID} --standalone -c /opt/kafka/config/server.properties &&
        /opt/kafka/bin/kafka-server-start.sh /opt/kafka/config/server.properties
      "